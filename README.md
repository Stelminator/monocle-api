API Router Connect
==================

A configuration-driven API router that exposes middleware for Connect to easily add to any Connect/Express server.

## Features

### Client-driven

Only each client knows their own needs, so when communicating with the API, each client can specify the properties of a resource it is interested. Want the `user` resource without getting a ton of extra data that you'll never use? No problem!

### Schemas

API Router uses [JSON Schema](http://json-schema.org/) to configure and validate APIs. This encourages API consistency by validating return values and allows you to view the schema by appending `?schema` to any resource URL.

## Basic Usage

```js
var connect = require('connect');
var app = connect();

var bodyParser = require('body-parser');
app.use(bodyParser.urlencoded({
    extended: false
}));

// Create an API Router instance
var ApiRouter = require('api-router-connect');
var api = new ApiRouter();

// Configure your first API route
api.get('/users/:userId', {
    type: 'object',
    properties: {
        userId: { type: 'integer' },
        displayName: { type: 'string' },
        age: { type: 'integer' },
        gender: { type: 'string' }
    }
}, function(params, req) {
    // params ex: { userId: '12345'}
    // req is the HTTP request object
    // return the data or a promise that resolves with the data
});

// Other properties for the same resource can be defined in separate handlers
api.get('/users/:userId', {
    type: 'object',
    properties: {
        userId: { type: 'integer' },
        email: { type: 'string' }
    }
}, function(params, req) {
    // return object with `email` property or a promise
});

// Add the API middleware to your connect app
app.use(api.middleware({
    basePath: '/'       // Optionally set a base path for all API routes
}));

// Create web server and listen on port 5150
var http = require('http');
http.createServer(app).listen(5150, function() {
    console.log("API Router listening on port 5150");
});
```

With your server set up, you can now make RESTful API calls, with support for enhanced features like specifying the properties you want back:

```bash
$ curl -i http://127.0.0.1:5150/my-api/users/1?props=userId,displayName,age
HTTP/1.1 200 OK
Content-Type: application/json
X-Response-Time: 1.424ms
Date: Thu, 13 Aug 2015 17:50:29 GMT
Connection: keep-alive
Transfer-Encoding: chunked

{
  "userId": 1,
  "displayName": "Alice",
  "age": 27
}

$ curl -i http://127.0.0.1:5150/my-api/users/1?props=userId,displayName,age,email
HTTP/1.1 200 OK
Content-Type: application/json
X-Response-Time: 1.768ms
Date: Thu, 13 Aug 2015 17:50:45 GMT
Connection: keep-alive
Transfer-Encoding: chunked

{
  "userId": 1,
  "displayName": "Alice",
  "age": 27,
  "email": "alice@example.com"
}

$ curl -i http://127.0.0.1:5150/my-api/users/500?props=userId,displayName,age
HTTP/1.1 404 Not Found
Content-Type: application/json
X-Response-Time: 1.590ms
Date: Thu, 13 Aug 2015 17:54:11 GMT
Connection: keep-alive
Transfer-Encoding: chunked

{
  "error": "Unable to find basic info for user id 500"
}

$ curl -i http://127.0.0.1:5150/my-api/users/1?schema
HTTP/1.1 200 OK
Content-Type: application/json
X-Response-Time: 0.169ms
Date: Thu, 13 Aug 2015 20:47:46 GMT
Connection: keep-alive
Transfer-Encoding: chunked

{
  "type": "object",
  "properties": {
    "userId": {
      "type": "integer"
    },
    "displayName": {
      "type": "string"
    },
    "age": {
      "type": "integer"
    },
    "gender": {
      "type": "string"
    },
    "email": {
      "type": "string"
    }
  }
}
```

See the demo for advanced usage.

## Files and Directory Structure

The following describes the various files in this repo and the directory structure.

**Note:** Files and directories prefixed by `*` are auto-generated and excluded from the
repository via `.gitignore`.

    .
    ├── Gruntfile.js            # grunt task configuration
    ├── README.md               # this file
    ├── *docs                   # autogenerated documentation
    │   └── *index.html         # each JS file in `./lib` has a corresponding HTML file for documentation
    ├── lib                     # all code for this library will be placed here
    │   └── index.js            # main entry point for the API router
    ├── *node_modules           # all dependencies will be installed here by npm
    ├── package.json            # description of this package for npm, including dependency lists
    └── test                    # unit test configuration, reports, and specs
        ├── *coverage.html      # code coverage report
        ├── lib                 # specs go here with a 1:1 mapping to code in `./lib`
        │   └── index_test.js   # spec for `./lib/index.js`
        ├── mocha.opts          # runtime options for mocha
        └── test_runner.js      # configures mocha environment (e.g. chai, sinon, etc.)

## Development

### Grunt

Grunt is a JavaScript task runner to automate common actions. The API Router project
supports the following grunt tasks:

**test**

Runs all unit tests through mocha.

    $ grunt test

**coverage**

Runs all unit tests and generates a code coverage report in `./test/coverage.html`

    $ grunt coverage

**watch**

Automatically runs mocha tests each time a file changes in `./lib` or `./test`.

    $ grunt watch

**docs**

Generates documentation for all JS files within `./lib` using docco. Documentation is
written to `./docs`.

    $ grunt docs

**clean**

Deletes all auto-generated files, including `./docs` and `./test/coverage.html`

### Mocha, Sinon, Chai, Blanket

The ultimate TDD environment for node. Place your specs in `./test/lib`, and run `grunt test`.

See `./test/lib/index_test.js` for examples.
